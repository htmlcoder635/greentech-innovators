<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Data Analyzer â€” GreenTech</title>
    <link rel="icon" type="image/png" href="assets/greentech-innovators_logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #34d399; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #10b981; }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased text-gray-800">

    <header class="bg-emerald-600 text-white shadow-lg sticky top-0 z-10">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between py-4">
            <h1 class="text-xl font-bold tracking-tight">GreenTech Innovators</h1>
            <nav class="flex space-x-2 sm:space-x-4">
                <a href="index.html" class="text-white hover:text-emerald-200 transition duration-150 ease-in-out px-3 py-2 rounded-md text-sm font-medium">Home</a>
                <a href="data_analyzer.html" class="text-emerald-200 hover:text-white transition duration-150 ease-in-out px-3 py-2 rounded-md text-sm font-medium border border-emerald-300">Data Analyzer</a>
                <a href="projects.html" class="text-white hover:text-emerald-200 transition duration-150 ease-in-out px-3 py-2 rounded-md text-sm font-medium">Projects</a>
                <a href="about.html" class="text-white hover:text-emerald-200 transition duration-150 ease-in-out px-3 py-2 rounded-md text-sm font-medium">About</a>
                <a href="volunteer.html" class="text-white hover:text-emerald-200 transition duration-150 ease-in-out px-3 py-2 rounded-md text-sm font-medium hidden md:inline-block">Volunteer</a>
                <a href="contact.html" class="text-white hover:text-emerald-200 transition duration-150 ease-in-out px-3 py-2 rounded-md text-sm font-medium">Contact</a>
            </nav>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        <h2 class="text-3xl font-extrabold text-gray-900 mb-2">Multimodal Analysis Hub</h2>
        <p class="text-base text-gray-500 mb-6">Upload any file type (data or image) and use AI to analyze its content.</p>

        <div class="bg-white shadow-xl rounded-xl p-6 mb-8 border border-gray-100">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
                
                <div class="col-span-12 md:col-span-8 space-y-4">
                    <label class="block text-sm font-medium text-gray-700">1. Upload File (CSV, XLS, PDF, JPEG, PNG)</label>
                    <input id="file-input" type="file" accept=".csv,.xls,.xlsx,.pdf,.jpeg,.jpg,.png" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 transition duration-150"/>
                    <div class="flex space-x-4">
                        <select id="timecol" title="Choose time column (optional)" class="flex-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 text-sm p-2">
                            <option value="">-- Time column (CSV only) --</option>
                        </select>
                        <select id="datacol" title="Choose data column to visualize" class="flex-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 text-sm p-2">
                            <option value="">-- Data column (CSV only) --</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-span-12 md:col-span-4 space-y-3">
                    <button class="w-full inline-flex justify-center rounded-lg border border-transparent bg-blue-600 py-2 text-sm font-semibold text-white shadow-md hover:bg-blue-700 transition" id="parse-btn" title="Local charts only work with CSV files.">Parse & Visualize (CSV Only)</button>
                    <button class="w-full inline-flex justify-center rounded-lg border border-transparent bg-yellow-600 py-2 text-sm font-semibold text-white shadow-md hover:bg-yellow-700 transition" id="ai-btn">Analyze File with AI</button>
                    <a class="text-sm font-medium text-emerald-600 hover:text-emerald-800 transition block text-center mt-2" id="download-report" style="display:none">Download Report</a>
                </div>
            </div>
        </div>
        <div id="no-data" class="text-center text-gray-400 py-10">
            <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-4m0 0l-1-1m1 1l1-1m-1 1h6m-3-3v6m0 0l1 1m-1-1l-1 1"/></svg>
            <p class="mt-1">No file loaded. Ready for your data!</p>
        </div>


        <div id="result-area" class="space-y-8" style="display:none">
            
            <div id="csv-stats">
                <h3 class="text-xl font-semibold text-gray-900 mb-3">Key Statistics Summary (Local CSV Parsing)</h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="summary">
                    </div>
            </div>

            <div id="csv-charts" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white shadow-lg rounded-xl p-5 border border-gray-100">
                    <h4 class="text-lg font-medium text-gray-900 mb-3">Time Series (Selected Column)</h4>
                    <div id="ts-wrapper" class="h-64">
                        <canvas id="timeseries"></canvas>
                    </div>
                </div>
                <div class="bg-white shadow-lg rounded-xl p-5 border border-gray-100">
                    <h4 class="text-lg font-medium text-gray-900 mb-3">Value Distribution (Histogram)</h4>
                    <div class="h-64">
                        <canvas id="hist"></canvas>
                    </div>
                </div>
            </div>

            <div id="csv-table" class="bg-white shadow-lg rounded-xl p-5 border border-gray-100">
                <h4 class="text-lg font-medium text-gray-900 mb-3">Parsed Data Sample (First 50 Rows)</h4>
                <div class="overflow-x-auto max-h-80" id="data-table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr id="data-table-header"></tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="data-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white shadow-lg rounded-xl p-5 border border-gray-100">
                <h4 class="text-lg font-medium text-gray-900 mb-3" id="ai-title">AI Interpretation</h4>
                <div class="flex flex-col sm:flex-row gap-6 items-start">
                    <div class="flex-1">
                        <div id="ai-output" class="text-sm text-emerald-700 min-h-[5rem] bg-emerald-50 p-4 rounded-lg border border-emerald-200 shadow-inner">
                            Click 'Analyze File with AI' to send the document/image for advanced interpretation.
                        </div>
                    </div>
                </div>
                <div id="ai-sources" class="mt-3 text-xs text-gray-500 hidden">
                    <p class="font-semibold mb-1">Sources Used:</p>
                    <ul id="ai-source-list" class="list-disc list-inside space-y-0.5 ml-2"></ul>
                </div>
            </div>

            <div class="bg-white shadow-lg rounded-xl p-5 border border-gray-100">
                <h4 class="text-lg font-medium text-gray-900 mb-3">Debug Information (API Details)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Request Payload Sample</label>
                        <pre id="request-payload" class="bg-gray-800 text-gray-200 p-3 rounded-lg overflow-auto max-h-64 text-xs">{}</pre>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Backend Response</label>
                        <pre id="response-payload" class="bg-gray-800 text-gray-200 p-3 rounded-lg overflow-auto max-h-64 text-xs">{}</pre>
                    </div>
                </div>
            </div>
        </div>
        </main>

    <footer class="mt-12 py-6 border-t border-gray-200 text-center text-gray-500">
        &copy; <span id="year2"></span> GreenTech Innovators. All rights reserved.
    </footer>

<script>
/* ---- CONSTANTS & SETUP ---- */
let parsed = { data: [], meta: null, columns: [] };
let chartStore = {}; 

// Gemini API Configuration
const API_KEY = ""; // Leave as-is
const API_MODEL = "gemini-2.5-flash-preview-09-2025";
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;


/* ---- UI ELEMENTS ---- */
const fileInput = document.getElementById('file-input');
const parseBtn = document.getElementById('parse-btn');
const aiBtn = document.getElementById('ai-btn');
const noData = document.getElementById('no-data');
const resultArea = document.getElementById('result-area');
const summaryEl = document.getElementById('summary');
const aiOutput = document.getElementById('ai-output');
const aiSources = document.getElementById('ai-sources');
const aiSourceList = document.getElementById('ai-source-list');
const timecolSelect = document.getElementById('timecol');
const datacolSelect = document.getElementById('datacol');
const dataTableBody = document.getElementById('data-table-body');
const dataTableHeader = document.getElementById('data-table-header');
const requestPayloadEl = document.getElementById('request-payload');
const responsePayloadEl = document.getElementById('response-payload');
const csvStats = document.getElementById('csv-stats');
const csvCharts = document.getElementById('csv-charts');
const csvTable = document.getElementById('csv-table');


/* ---- CORE DATA PARSING & UI RESET ---- */
function resetUI(keepFileMessage = false){
    // Reset AI output
    aiOutput.innerHTML = 'Click \'Analyze File with AI\' to send the document/image for advanced interpretation.';
    aiSources.classList.add('hidden');
    aiSourceList.innerHTML = '';
    
    // Reset CSV-specific UI elements
    csvStats.style.display = 'none';
    csvCharts.style.display = 'none';
    csvTable.style.display = 'none';
    summaryEl.innerHTML = '';
    
    // Debug panels
    requestPayloadEl.textContent = '{}';
    responsePayloadEl.textContent = '{}';
    
    // destroy charts
    Object.values(chartStore).forEach(c => c?.destroy && c.destroy());
    chartStore = {};
    const tsWrapper = document.getElementById('ts-wrapper');
    tsWrapper.innerHTML = '<canvas id="timeseries"></canvas>'; // Re-create canvas placeholder
    dataTableBody.innerHTML = '';
    dataTableHeader.innerHTML = '';
    
    // Reset parsed data state
    parsed = { data: [], meta: null, columns: [] };
    
    // Reset status message unless keeping it
    if (!keepFileMessage) {
        resultArea.style.display = 'none';
        noData.style.display = 'block';
        noData.innerHTML = `<svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-4m0 0l-1-1m1 1l1-1m-1 1h6m-3-3v6m0 0l1 1m-1-1l-1 1"/></svg><p class="mt-1">No file loaded. Ready for your data!</p>`;
    }
}

fileInput.addEventListener('change', () => {
    resetUI(true); // Keep the file message when a file is selected
    if (fileInput.files.length) {
        const file = fileInput.files[0];
        noData.style.display = 'none';
        resultArea.style.display = 'block';
        
        // Show file loaded message in the AI output panel initially
        aiOutput.innerHTML = `<div class="font-semibold text-emerald-700">File Loaded: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB, Type: ${file.type || getMimeType(file.name)}).</div><div class="mt-2 text-gray-600">Click 'Parse & Visualize (CSV Only)' for local charts, or 'Analyze File with AI' for multimodal interpretation.</div>`;

        // Reset CSV data for new file
        parsed = { data: [], meta: null, columns: [] };
        populateColumnSelectors([]); // Clear selectors
    }
});

parseBtn.addEventListener('click', () => {
    if(!fileInput.files.length) return showTempMessage('Choose a file first.', 'error');
    const file = fileInput.files[0];
    const fileName = file.name.toLowerCase();

    // Only proceed with PapaParse if the file is a CSV
    if (fileName.endsWith('.csv')) {
        Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                parsed.data = results.data;
                parsed.meta = results.meta;
                parsed.columns = results.meta && results.meta.fields ? results.meta.fields : Object.keys(results.data[0] || {});
                
                populateColumnSelectors(parsed.columns);
                csvStats.style.display = 'block';
                csvCharts.style.display = 'grid';
                csvTable.style.display = 'block';
                renderSummaries(parsed);
                renderDataTable(parsed);
                showTempMessage(`Successfully parsed ${parsed.data.length} rows of CSV data.`, 'success');
            },
            error: function(err){ showTempMessage('CSV parse error: ' + (err.message || err), 'error'); }
        });
    } else {
        // Prevent local parsing for non-CSV files
        showTempMessage(`Local parsing and charting is only supported for CSV files. Use 'Analyze File with AI' for ${file.name}.`, 'info');
        // Ensure CSV specific sections are hidden
        csvStats.style.display = 'none';
        csvCharts.style.display = 'none';
        csvTable.style.display = 'none';
    }
});

/* ---- AI ANALYSIS (Gemini API Integration) ---- */

/**
 * Reads a File object and converts it to a Base64 encoded string.
 * @param {File} file - The file to read.
 * @returns {Promise<string>} The Base64 data string.
 */
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            // Data URL format: data:[<mime type>][;charset=<charset>][;base64],<data>
            // We strip the "data:mime/type;base64," prefix.
            const base64String = reader.result.split(',')[1];
            resolve(base64String);
        };
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

function getMimeType(fileName) {
    const extension = fileName.split('.').pop().toLowerCase();
    switch (extension) {
        case 'csv': return 'text/csv';
        case 'xls': 
        case 'xlsx': return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
        case 'pdf': return 'application/pdf';
        case 'jpeg':
        case 'jpg': return 'image/jpeg';
        case 'png': return 'image/png';
        default: return 'application/octet-stream';
    }
}

async function callGeminiAPI(payload, maxRetries = 3) {
    for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                // Throw an error that includes the status for better error display
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}...`);
            }

            const result = await response.json();
            return result;
        } catch (error) {
            if (attempt === maxRetries - 1) {
                throw error;
            }
            // Exponential backoff
            const delay = Math.pow(2, attempt) * 1000;
            // console.log(`Retry attempt ${attempt + 1} after ${delay}ms...`); // Commented out for no logging rule
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
}

aiBtn.addEventListener('click', async () => {
    if (!fileInput.files.length) return showTempMessage('Please select a file to analyze.', 'error');

    const file = fileInput.files[0];
    const mimeType = file.type || getMimeType(file.name);

    if (file.size > 20 * 1024 * 1024) { // Check for file size limit (20MB as a safety measure)
        return showTempMessage(`File size limit exceeded. Max 20MB supported for AI analysis. Your file is ${(file.size / 1024 / 1024).toFixed(2)} MB.`, 'error');
    }
    
    aiOutput.innerHTML = '<div class="flex items-center space-x-2 text-gray-600"><svg class="animate-spin h-5 w-5 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Analyzing file content with Gemini...</span></div>';
    aiSources.classList.add('hidden');
    aiSourceList.innerHTML = '';
    
    let base64Data;
    try {
        base64Data = await fileToBase64(file);
    } catch(err) {
        aiOutput.innerHTML = `<div class="text-red-600 font-semibold">File Read Error: Could not read the file into Base64.</div>`;
        return showTempMessage('Failed to read file.', 'error');
    }

    const userQuery = "Analyze this file. Identify the content (e.g., image, table, report, etc.), extract key information, and provide a professional, detailed, and clear summary of its content. If it contains data, summarize the statistics and trends. If it contains text, summarize the main points and context.";

    const payload = {
        contents: [
            {
                role: "user",
                parts: [
                    { text: userQuery },
                    {
                        inlineData: {
                            mimeType: mimeType,
                            data: base64Data
                        }
                    }
                ]
            }
        ],
        tools: [{ "google_search": {} }],
        systemInstruction: { parts: [{ text: "You are an expert data analyst and multimodal interpretation specialist. Your task is to analyze the provided file and provide a professional, detailed, and clear summary of its content. Use markdown formatting." }] },
    };
    
    // Log request payload
    const debugPayloadText = JSON.stringify(payload, (key, value) => {
        // Truncate base64 data for logging brevity
        if (key === 'data' && typeof value === 'string') {
            return value.substring(0, 100) + '... (data truncated)';
        }
        return value;
    }, 2);
    requestPayloadEl.textContent = debugPayloadText;

    try {
        const result = await callGeminiAPI(payload);
        responsePayloadEl.textContent = JSON.stringify(result, null, 2);

        const candidate = result.candidates?.[0];

        if (candidate && candidate.content?.parts?.[0]?.text) {
            const text = candidate.content.parts[0].text;
            // Use a simple div for markdown rendering, assuming the environment handles it well
            aiOutput.innerHTML = `<div class="prose text-sm max-w-none text-gray-800">${text}</div>`;
            
            // Extract grounding sources
            let sources = [];
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri && source.title);
            }
            
            if (sources.length > 0) {
                aiSources.classList.remove('hidden');
                aiSourceList.innerHTML = ''; // Clear previous sources
                sources.forEach((s, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${s.uri}" target="_blank" class="text-blue-600 hover:text-blue-800 transition truncate block" title="${s.title}">${index + 1}. ${s.title}</a>`;
                    aiSourceList.appendChild(li);
                });
            } else {
                aiSources.classList.add('hidden');
            }

        } else {
            aiOutput.innerHTML = `<div class="text-red-600 font-semibold">AI Error: Failed to generate content. Response was incomplete or blocked. Check the Debug Information panel.</div>`;
        }

    } catch (error) {
        let displayError = error.message;

        if (error.message.includes('HTTP error! status: 403')) {
            displayError = "Authentication Failed (403 Forbidden). The API key is likely missing or invalid. Please ensure the environment is correctly providing the key.";
        } else if (error.message.includes('400')) {
             displayError = "Invalid Request (400 Bad Request). The file or prompt format may be incorrect.";
        }
        
        responsePayloadEl.textContent = JSON.stringify({ error: displayError, originalError: error.message }, null, 2);
        aiOutput.innerHTML = `<div class="text-red-600 font-semibold">Analysis Failed: ${displayError}</div>`;
        showTempMessage('AI Analysis failed.', 'error');
    }
});


/* ---- RENDERING FUNCTIONS (Mainly for CSV local analysis) ---- */

function populateColumnSelectors(cols){
    timecolSelect.innerHTML = '<option value="">-- Time column (CSV only) --</option>';
    datacolSelect.innerHTML = '<option value="">-- Data column (CSV only) --</option>';
    cols.forEach(c => {
        const o1 = document.createElement('option'); o1.value = c; o1.innerText = c; timecolSelect.appendChild(o1);
        const o2 = document.createElement('option'); o2.value = c; o2.innerText = c; datacolSelect.appendChild(o2);
    });
}

function renderSummaries(parsed){
    summaryEl.innerHTML = '';
    const n = parsed.data.length;
    const cols = parsed.columns;

    summaryEl.appendChild(createStatBox('Total Rows', n.toLocaleString(), 'text-blue-600', 'Total number of records loaded.'));
    summaryEl.appendChild(createStatBox('Columns', cols.length, 'text-purple-600', `Detected columns: ${cols.join(', ').slice(0, 50)}...`));

    const numericCols = cols.filter(c => isNumericColumn(parsed.data, c));
    
    summaryEl.appendChild(createStatBox('Numeric Cols', numericCols.length, 'text-green-600', `Numeric columns available for charting: ${numericCols.length}`));

    if(numericCols.length){
        const col = numericCols[0];
        datacolSelect.value = datacolSelect.value || col;
        
        const values = parsed.data.map(r => r[col]).filter(v => v !== null && v !== undefined && !Number.isNaN(v));
        const stats = computeStats(values);

        summaryEl.appendChild(createStatBox(`Mean (${col})`, round(stats.mean), 'text-orange-600', `Standard Deviation: ${round(stats.std)}`));
        
        drawCharts(parsed, datacolSelect.value, timecolSelect.value || null);
    } else {
        datacolSelect.value = datacolSelect.value || (cols[0] || '');
        if(datacolSelect.value) drawCharts(parsed, datacolSelect.value, timecolSelect.value || null);
    }
}

function renderDataTable(parsed) {
    dataTableHeader.innerHTML = '';
    dataTableBody.innerHTML = '';
    
    // Header
    parsed.columns.forEach(col => {
        const th = document.createElement('th');
        th.className = 'px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50';
        th.innerText = col;
        dataTableHeader.appendChild(th);
    });
    
    // Body (Limit to first 50 rows)
    parsed.data.slice(0, 50).forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        parsed.columns.forEach(col => {
            const td = document.createElement('td');
            td.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-700';
            let value = row[col];
            if (value === null || value === undefined) {
                value = '-';
                td.classList.add('text-gray-400', 'italic');
            } else if (typeof value === 'object') {
                value = JSON.stringify(value); 
            }
            td.innerText = value;
            tr.appendChild(td);
        });
        dataTableBody.appendChild(tr);
    });
}

function createStatBox(title, value, valueClass, subText) {
    const box = document.createElement('div');
    box.className = 'bg-gray-50 rounded-lg p-4 shadow-md border border-gray-200';
    box.innerHTML = `
        <p class="text-sm font-medium text-gray-500">${title}</p>
        <p class="text-2xl font-bold mt-1 ${valueClass}">${value}</p>
        <p class="text-xs text-gray-400 mt-2 truncate">${subText}</p>
    `;
    return box;
}

datacolSelect.addEventListener('change', () => {
    if(parsed.data.length && datacolSelect.value) drawCharts(parsed, datacolSelect.value, timecolSelect.value || null);
});
timecolSelect.addEventListener('change', () => {
    if(parsed.data.length && datacolSelect.value) drawCharts(parsed, datacolSelect.value, timecolSelect.value || null);
});

function drawCharts(parsed, dataCol, timeCol){
    const rows = parsed.data.filter(r => r[dataCol] !== null && r[dataCol] !== undefined && !Number.isNaN(r[dataCol]));
    let labels = [], values = [];
    if(timeCol && parsed.columns.includes(timeCol)) {
        rows.sort((a,b) => new Date(a[timeCol]) - new Date(b[timeCol]));
        labels = rows.map(r => r[timeCol]);
        values = rows.map(r => r[dataCol]);
    } else {
        labels = rows.map((_,i) => i+1);
        values = rows.map(r => r[dataCol]);
    }

    const tsCanvas = document.getElementById('timeseries');
    renderLineChart(tsCanvas, labels, values, dataCol);

    const histCanvas = document.getElementById('hist');
    renderHistogram(histCanvas, values);
}

function renderLineChart(canvas, labels, data, label) {
    if (chartStore['ts']) chartStore['ts'].destroy();
    
    chartStore['ts'] = new Chart(canvas, {
        type: 'line',
        data: { 
            labels: labels, 
            datasets: [{ 
                label: label, 
                data: data, 
                tension: 0.3, 
                fill: true,
                backgroundColor: 'rgba(52, 211, 153, 0.2)', // Tailwind green-300
                borderColor: '#10b981', // Tailwind green-600
                pointRadius: 0
            }]
        },
        options: { 
            responsive: true,
            maintainAspectRatio: false,
            plugins:{ legend:{ display:false } },
            scales: {
                x: {
                    title: { display: true, text: timecolSelect.value || 'Index' },
                    ticks: { maxTicksLimit: 10 }
                },
                y: {
                    title: { display: true, text: label }
                }
            }
        }
    });
}

function renderHistogram(canvas, values) {
    if(chartStore['hist']) chartStore['hist'].destroy();
    if (values.length === 0) {
        chartStore['hist'] = new Chart(canvas, { type:'bar', data:{ labels: ['No Data'], datasets:[{ data: [0] }] } });
        return;
    }

    const bins = 12;
    const min = Math.min(...values);
    const max = Math.max(...values);
    const range = max - min;
    const width = (range === 0) ? 1 : range / bins;
    
    const counts = new Array(bins).fill(0);
    values.forEach(v => {
        let idx = Math.floor((v - min) / width);
        if(idx >= bins) idx = bins - 1;
        if(idx < 0) idx = 0;
        counts[idx]++;
    });
    
    const labels = counts.map((_,i) => {
        const start = round(min + i*width);
        const end = round(min + (i+1)*width);
        return `${start} - ${end}`;
    });

    chartStore['hist'] = new Chart(canvas, { 
        type:'bar', 
        data:{ 
            labels: labels, 
            datasets:[{ 
                label:'Count', 
                data: counts,
                backgroundColor: '#f59e0b', // Tailwind yellow-600
                borderColor: '#b45309', // Tailwind yellow-800
                borderWidth: 1 
            }] 
        }, 
        options:{ 
            responsive:true,
            maintainAspectRatio: false,
            plugins:{ legend:{display:false} },
            scales: {
                x: { title: { display: true, text: 'Value Bins' } },
                y: { title: { display: true, text: 'Frequency' } }
            }
        }
    });
}


/* ---- UTILITY FUNCTIONS ---- */

function showTempMessage(message, type = 'info') {
    const color = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
    const tempDiv = document.createElement('div');
    tempDiv.className = `fixed bottom-4 right-4 p-4 text-white rounded-lg shadow-xl z-50 ${color} transition-opacity duration-300`;
    tempDiv.innerText = message;
    document.body.appendChild(tempDiv);
    
    setTimeout(() => {
        tempDiv.classList.remove('opacity-100');
        tempDiv.classList.add('opacity-0');
        setTimeout(() => tempDiv.remove(), 300);
    }, 4000);
}

function isNumericColumn(data, col) {
    for(let i=0;i<Math.min(30,data.length);i++){
        const v = data[i][col];
        if(v === null || v === undefined) continue;
        return typeof v === 'number' && !Number.isNaN(v);
    }
    return false;
}
function computeStats(arr) {
    const n = arr.length;
    if(n===0) return {mean:0,median:0,std:0};
    const mean = arr.reduce((a,b)=>a+b,0)/n;
    const sorted = arr.slice().sort((a,b)=>a-b);
    const median = (sorted[Math.floor((n-1)/2)] + sorted[Math.ceil((n-1)/2)])/2;
    const std = Math.sqrt(arr.reduce((s,x)=>s + Math.pow(x-mean,2),0)/Math.max(1,n)); 
    return {mean, median, std};
}
function round(x) { return Math.round(x*100)/100 }

document.getElementById('year2').innerText = new Date().getFullYear();

// Initial state
resetUI();
</script>
</body>
</html>
